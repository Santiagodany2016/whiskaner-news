<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Whiskaner News</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: #f8f8f8;
      color: #222;
    }
    header {
      background: #222;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #eee;
      gap: .25rem;
      padding: .25rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    nav button {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 1rem;
      border-radius: .5rem;
    }
    nav button.active {
      background: #ddd;
      font-weight: 600;
    }
    main {
      padding: 1rem;
      max-width: 1100px;
      margin: auto;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .controls input[type="search"] {
      flex: 1;
      min-width: 220px;
      padding: 0.6rem 0.75rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: .5rem;
      background: #fff;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.95rem;
      padding: .4rem .6rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: .5rem;
    }
    .status {
      margin: .5rem 0 1rem;
      font-size: .95rem;
      color: #555;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      border: 1px solid #eee;
    }
    .card .media {
      width: 100%;
      height: 160px;
      background: #f0f0f0;
      display: block;
      object-fit: cover;
    }
    .card-content {
      padding: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
      flex: 1;
    }
    .card-content h3 {
      font-size: 1rem;
      margin: 0;
      line-height: 1.25;
    }
    .card-content a {
      color: #0b61c2;
      text-decoration: none;
    }
    .card-content a:hover {
      text-decoration: underline;
    }
    .meta {
      font-size: .85rem;
      color: #666;
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .empty, .error {
      background: #fff3f3;
      border: 1px solid #ffd6d6;
      color: #b00020;
      padding: .75rem;
      border-radius: .5rem;
    }
    .empty {
      background: #f7faff;
      border-color: #d6e6ff;
      color: #124d9c;
    }
  </style>
</head>
<body>
  <header>
    <h1>Whiskaner News</h1>
  </header>

  <nav>
    <button data-filter="all" class="active">Todo</button>
    <button data-filter="article">Artículos</button>
    <button data-filter="podcast">Podcasts</button>
  </nav>

  <main>
    <div class="controls">
      <input type="search" id="search" placeholder="Buscar por título o fuente..." />
      <label><input type="checkbox" id="breaking48"> Breaking 48h</label>
    </div>

    <div id="status" class="status"></div>
    <div id="grid" class="grid"></div>
  </main>

  <script>
    const FEED_URL = './feed.json'; // relativo a /docs en GitHub Pages
    let items = [];
    let currentFilter = 'all';

    // Utilidades
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    async function loadFeed() {
      const status = $('#status');
      try {
        status.textContent = 'Cargando feed...';
        const res = await fetch(FEED_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(\`HTTP \${res.status} \${res.statusText}\`);
        const data = await res.json();
        items = Array.isArray(data?.items) ? data.items : [];
        status.textContent = \`Cargados \${items.length} ítems.\`;
        render();
      } catch (err) {
        console.error(err);
        $('#grid').innerHTML = '<div class="error">Error cargando el feed. Revisa que <code>docs/feed.json</code> exista y sea JSON válido.</div>';
        status.textContent = '';
      }
    }

    function render() {
      const grid = $('#grid');
      const q = $('#search').value.trim().toLowerCase();
      const breakingOnly = $('#breaking48').checked;

      const now = Date.now();
      const cutoff = now - 48 * 3600 * 1000;

      const filtered = items.filter((it) => {
        if (!it) return false;
        if (currentFilter !== 'all' && it.type !== currentFilter) return false;

        // Búsqueda por título o fuente
        const title = (it.title || '').toString().toLowerCase();
        const source = (it.source || '').toString().toLowerCase();
        if (q && !title.includes(q) && !source.includes(q)) return false;

        // Breaking 48h
        const ts = new Date(it.published_at || it.pubDate || it.isoDate || 0).getTime();
        if (breakingOnly && !(ts >= cutoff)) return false;

        return true;
      });

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty">No hay resultados con los filtros actuales.</div>';
        return;
      }

      // Render tarjetas
      grid.innerHTML = filtered.map((it) => {
        const isPodcast = it.type === 'podcast';
        // Artículos: se muestra imagen si existe; Podcasts: nunca se muestra imagen
        const showImage = !isPodcast && !!it.image;
        const imgHtml = showImage ? \`<img class="media" src="\${it.image}" alt="" loading="lazy" onerror="this.style.display='none'">\` : '';

        const date = new Date(it.published_at || it.pubDate || it.isoDate || 0);
        const dateText = isNaN(date.getTime()) ? '' : date.toLocaleString();

        return \`
          <article class="card">
            \${imgHtml}
            <div class="card-content">
              <h3><a href="\${it.url}" target="_blank" rel="noopener">\${escapeHtml(it.title || '')}</a></h3>
              <div class="meta">
                <span><strong>\${escapeHtml(it.source || '')}</strong></span>
                <span>\${dateText}</span>
                <span>\${it.type}</span>
              </div>
            </div>
          </article>
        \`;
      }).join('');
    }

    // Sencilla protección XSS para el título/fuente
    function escapeHtml(s) {
      return (s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Eventos UI
    $$('#search, #breaking48').forEach(el => {
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    $$('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        render();
      });
    });

    // Inicio
    loadFeed();
  </script>
</body>
</html>
